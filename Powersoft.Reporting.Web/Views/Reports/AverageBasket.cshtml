@model Powersoft.Reporting.Web.ViewModels.AverageBasketViewModel
@{
    ViewData["Title"] = "Average Basket Report";
    var filterCols = new[] { "Period", "GroupName", "Group2Name", "Invoices", "Returns", "NetTransactions", "QtySold", "QtyReturned", "NetQty", "Sales", "AvgBasket", "AvgQty" };
    bool hasAnyFilter = Model.FilterValues != null && Model.FilterValues.Any(kv => !string.IsNullOrEmpty(kv.Value));
}

<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-controller="Reports" asp-action="Index">Reports</a></li>
                <li class="breadcrumb-item"><a asp-controller="Reports" asp-action="Index">Stock Control</a></li>
                <li class="breadcrumb-item active">Average Basket</li>
            </ol>
        </nav>
        <h2 class="mb-0">
            <i class="bi bi-basket me-2 text-primary"></i>Average Basket Report
        </h2>
        <p class="text-muted mb-0">Analyze sales performance and average transaction values</p>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-funnel me-2"></i>Report Parameters
    </div>
    <div class="card-body">
        <form asp-action="AverageBasket" method="post" id="reportForm">
            <input type="hidden" asp-for="SelectedStoreCodesString" id="selectedStoreCodesHidden" />
            <input type="hidden" asp-for="SelectedItemIdsString" id="selectedItemIdsHidden" />
            <input type="hidden" asp-for="PageNumber" id="pageNumberHidden" />
            <input type="hidden" asp-for="SortColumn" id="sortColumnHidden" />
            <input type="hidden" asp-for="SortDirection" id="sortDirectionHidden" />
            <input type="hidden" asp-for="HiddenColumns" id="hiddenColumnsInput" />
            @foreach (var col in filterCols)
            {
                <input type="hidden" name="FilterValues[@col]" id="fv_@col" value="@(Model.FilterValues.GetValueOrDefault(col, ""))" />
                <input type="hidden" name="FilterOperators[@col]" id="fo_@col" value="@(Model.FilterOperators.GetValueOrDefault(col, ""))" />
            }
            
            <div class="row mb-3">
                <div class="col-12">
                    <label class="form-label fw-semibold mb-2">Quick Date Selection</label>
                    <div class="date-presets btn-group flex-wrap" role="group">
                        <input type="radio" class="btn-check" name="DatePreset" id="presetToday" value="today" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="presetToday">Today</label>
                        
                        <input type="radio" class="btn-check" name="DatePreset" id="presetYesterday" value="yesterday" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="presetYesterday">Yesterday</label>
                        
                        <input type="radio" class="btn-check" name="DatePreset" id="presetLast7" value="last7" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="presetLast7">Last 7 Days</label>
                        
                        <input type="radio" class="btn-check" name="DatePreset" id="presetLast30" value="last30" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="presetLast30">Last 30 Days</label>
                        
                        <input type="radio" class="btn-check" name="DatePreset" id="presetThisMonth" value="thisMonth" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="presetThisMonth">This Month</label>
                        
                        <input type="radio" class="btn-check" name="DatePreset" id="presetLastMonth" value="lastMonth" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="presetLastMonth">Last Month</label>
                        
                        <input type="radio" class="btn-check" name="DatePreset" id="presetYTD" value="ytd" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="presetYTD">Year to Date</label>
                        
                        <input type="radio" class="btn-check" name="DatePreset" id="presetLastYear" value="lastYear" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="presetLastYear">Last Year</label>
                    </div>
                </div>
            </div>
            
            <hr class="my-3">
            
            <div class="row g-3 mb-3 align-items-end">
                <div class="col-6 col-md-2">
                    <label class="form-label fw-semibold">Date From</label>
                    <input type="date" asp-for="DateFrom" class="form-control" onchange="clearPreset()" />
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label fw-semibold">Date To</label>
                    <input type="date" asp-for="DateTo" class="form-control" onchange="clearPreset()" />
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label fw-semibold">Breakdown</label>
                    <select asp-for="Breakdown" class="form-select" asp-items="Html.GetEnumSelectList<Powersoft.Reporting.Core.Enums.BreakdownType>()"></select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label fw-semibold">Group By</label>
                    <select asp-for="GroupBy" class="form-select" asp-items="Html.GetEnumSelectList<Powersoft.Reporting.Core.Enums.GroupByType>()"></select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label fw-semibold">Then By</label>
                    <select asp-for="SecondaryGroupBy" class="form-select" asp-items="Html.GetEnumSelectList<Powersoft.Reporting.Core.Enums.GroupByType>()"></select>
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-semibold">Stores</label>
                    <div class="store-select-container">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-shop"></i></span>
                            <div class="form-control store-multiselect" id="storeSelector" role="button" aria-haspopup="listbox" aria-expanded="false" onclick="toggleStoreDropdown(event)">
                                <span id="storeSelectionText">All Stores</span>
                            </div>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearStoreSelection()" title="Clear store selection">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <div class="store-dropdown" id="storeDropdown" role="listbox">
                            <div class="store-search p-2">
                                <input type="text" class="form-control form-control-sm" placeholder="Search stores..." 
                                       id="storeSearchInput" onkeyup="filterStores()" aria-label="Search stores">
                            </div>
                            <div class="store-list" id="storeList">
                                @foreach (var store in Model.AvailableStores)
                                {
                                    var isChecked = Model.SelectedStoreCodes.Contains(store.StoreCode);
                                    <label class="store-item" data-code="@store.StoreCode" data-name="@store.StoreName.ToLower()">
                                        <input type="checkbox" value="@store.StoreCode" @(isChecked ? "checked" : "") onchange="updateStoreSelection()">
                                        <span>@store.DisplayName</span>
                                    </label>
                                }
                            </div>
                            <div class="store-actions p-2 border-top">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllStores()">Select All</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearStoreSelection()">Clear All</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-semibold">Items</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-box-seam"></i></span>
                        <div class="form-control item-selector" id="itemSelector" role="button" onclick="openItemsModal()">
                            <span id="itemSelectionText">All Items</span>
                        </div>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearItemSelection()" title="Clear item selection">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="row g-3 mb-4 align-items-end">
                <div class="col-auto">
                    <div class="form-check">
                        <input type="checkbox" asp-for="IncludeVat" class="form-check-input" id="includeVatCheck" />
                        <label asp-for="IncludeVat" class="form-check-label" for="includeVatCheck">Include VAT</label>
                    </div>
                </div>
                <div class="col-auto">
                    <div class="form-check">
                        <input type="checkbox" asp-for="CompareLastYear" class="form-check-input" id="compareLyCheck" />
                        <label asp-for="CompareLastYear" class="form-check-label" for="compareLyCheck">Compare with Last Year</label>
                    </div>
                </div>
                <div class="col-auto ms-md-auto">
                    <label class="form-label fw-semibold small text-muted mb-1">Rows per page</label>
                    <select asp-for="PageSize" class="form-select form-select-sm w-auto">
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                    </select>
                </div>
            </div>
            
            <div class="report-form-actions d-flex flex-wrap gap-2 pt-2 border-top">
                <button type="submit" class="btn btn-primary btn-lg btn-generate" id="generateBtn">
                    <span class="btn-text"><i class="bi bi-play-fill me-2"></i>Generate Report</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </button>
                <button type="button" class="btn btn-warning btn-lg" data-bs-toggle="modal" data-bs-target="#scheduleModal" title="Schedule recurring report delivery">
                    <i class="bi bi-clock-history me-2"></i>Schedule
                </button>
                <div class="btn-group ms-auto">
                    <button type="button" class="btn btn-outline-info" onclick="saveCurrentLayout()" title="Save current parameters as your default layout">
                        <i class="bi bi-save me-1"></i>Save Layout
                    </button>
                    @if (Model.HasSavedLayout)
                    {
                        <button type="button" class="btn btn-outline-secondary" onclick="resetSavedLayout()" title="Discard your saved layout and restore factory defaults">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>Reset Layout
                        </button>
                    }
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#columnSettingsModal" title="Choose which columns to show/hide">
                        <i class="bi bi-layout-three-columns me-1"></i>Columns
                    </button>
                </div>
                <a asp-action="AverageBasket" asp-route-clearedFilters="true" class="btn btn-outline-secondary btn-reset" title="Clear all column filters. Your saved layout is preserved.">
                    <i class="bi bi-funnel me-1"></i>Clear Filters
                </a>
            </div>
            @if (Model.HasSavedLayout)
            {
                <div class="mt-2">
                    <small class="text-info"><i class="bi bi-check-circle me-1"></i>Saved layout loaded</small>
                </div>
            }
        </form>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <div class="d-flex align-items-start">
            <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
            <div>
                <strong>Unable to generate report</strong>
                <p class="mb-0 mt-1">@Model.ErrorMessage</p>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["Warning"] != null)
{
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <i class="bi bi-info-circle-fill me-2"></i>
        @TempData["Warning"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (Model.Results.Any())
{
    var gt0 = Model.GrandTotals;
    var showGtCards = gt0 != null;
    var cardTransactions = showGtCards ? gt0!.NetTransactions : Model.TotalTransactions;
    var cardQty = showGtCards ? gt0!.NetQty : Model.TotalQty;
    var cardSales = showGtCards 
        ? (Model.IncludeVat ? gt0!.GrossSales : gt0!.NetSales) 
        : (Model.IncludeVat ? Model.TotalGrossSales : Model.TotalNetSales);
    var cardAvg = showGtCards 
        ? (Model.IncludeVat ? gt0!.AverageBasketGross : gt0!.AverageBasketNet) 
        : Model.OverallAverageBasket;

    <div class="row mb-4 g-3">
        <div class="col-6 col-md-3">
            <div class="stat-card text-center">
                <div class="stat-value">@cardTransactions.ToString("N0")</div>
                <div class="stat-label">Net Transactions</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card text-center">
                <div class="stat-value">@cardQty.ToString("N0")</div>
                <div class="stat-label">Items Sold</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card text-center">
                <div class="stat-value">@cardSales.ToString("N2")</div>
                <div class="stat-label">Total Sales</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card text-center">
                <div class="stat-value text-primary">@cardAvg.ToString("N2")</div>
                <div class="stat-label">Avg. Basket</div>
            </div>
        </div>
        @if (Model.CompareLastYear && gt0 != null)
        {
            var yoyClass = gt0.YoYChangePercent >= 0 ? "text-success" : "text-danger";
            var yoyIcon = gt0.YoYChangePercent >= 0 ? "bi-arrow-up" : "bi-arrow-down";
            <div class="col-6 col-md-3">
                <div class="stat-card text-center">
                    <div class="stat-value @yoyClass"><i class="bi @yoyIcon me-1"></i>@gt0.YoYChangePercent.ToString("N1")%</div>
                    <div class="stat-label">YoY Change</div>
                </div>
            </div>
        }
    </div>
    
    <div class="card" id="results">
        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
            <span>
                <i class="bi bi-table me-2"></i>
                Results: @Model.TotalCount total rows
                @if (Model.HasStoreFilter)
                {
                    <span class="badge bg-info ms-2">@Model.SelectedStoreCodes.Count stores filtered</span>
                }
                @if (Model.HasItemFilter)
                {
                    <span class="badge bg-info ms-2">@Model.SelectedItemIds.Count items filtered</span>
                }
                @if (Model.HasGrouping)
                {
                    <span class="badge bg-secondary ms-2">Grouped by @Model.GroupBy</span>
                }
                @if (Model.HasSecondaryGrouping)
                {
                    <span class="badge bg-secondary ms-1">then @Model.SecondaryGroupBy</span>
                }
            </span>
            <div class="d-flex gap-2 flex-wrap align-items-center">
                @if (hasAnyFilter)
                {
                    <button class="btn btn-sm btn-outline-warning" onclick="clearAllFilters()" title="Clear column filter inputs and refresh">
                        <i class="bi bi-funnel me-1"></i>Clear column filters
                    </button>
                }
                <button class="btn btn-sm btn-outline-primary" onclick="togglePreview()" id="previewToggleBtn" title="Toggle document preview">
                    <i class="bi bi-eye me-1"></i>Preview
                </button>
                <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-success" onclick="exportToCSV()">
                    <i class="bi bi-filetype-csv me-1"></i>CSV
                </button>
                <a class="btn btn-outline-success" asp-action="ExportExcel" asp-route-dateFrom="@Model.DateFrom.ToString("yyyy-MM-dd")" asp-route-dateTo="@Model.DateTo.ToString("yyyy-MM-dd")" asp-route-breakdown="@Model.Breakdown" asp-route-groupBy="@Model.GroupBy" asp-route-secondaryGroupBy="@Model.SecondaryGroupBy" asp-route-includeVat="@Model.IncludeVat" asp-route-compareLastYear="@Model.CompareLastYear" asp-route-storeCodes="@Model.SelectedStoreCodesString" asp-route-itemIds="@(Model.SelectedItemIdsString ?? "")" asp-route-sortColumn="@Model.SortColumn" asp-route-sortDirection="@Model.SortDirection">
                    <i class="bi bi-filetype-xlsx me-1"></i>Excel
                </a>
                <a class="btn btn-outline-danger" asp-action="ExportPdf" asp-route-dateFrom="@Model.DateFrom.ToString("yyyy-MM-dd")" asp-route-dateTo="@Model.DateTo.ToString("yyyy-MM-dd")" asp-route-breakdown="@Model.Breakdown" asp-route-groupBy="@Model.GroupBy" asp-route-secondaryGroupBy="@Model.SecondaryGroupBy" asp-route-includeVat="@Model.IncludeVat" asp-route-compareLastYear="@Model.CompareLastYear" asp-route-storeCodes="@Model.SelectedStoreCodesString" asp-route-itemIds="@(Model.SelectedItemIdsString ?? "")" asp-route-sortColumn="@Model.SortColumn" asp-route-sortDirection="@Model.SortDirection">
                    <i class="bi bi-filetype-pdf me-1"></i>PDF
                </a>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="resultsTable">
                    @{
                        var sc = Model.SortColumn ?? "Period";
                        var sd = Model.SortDirection ?? "ASC";
                        string SortClass(string col) => sc.Equals(col, StringComparison.OrdinalIgnoreCase)
                            ? (sd == "ASC" ? "sortable sort-asc" : "sortable sort-desc")
                            : "sortable";
                        string SortIcon(string col) => sc.Equals(col, StringComparison.OrdinalIgnoreCase)
                            ? (sd == "ASC" ? "bi-caret-up-fill" : "bi-caret-down-fill")
                            : "bi-caret-up-fill";
                    }
                    @{
                        string FilterVal(string col) => (Model.FilterValues ?? new Dictionary<string, string>()).GetValueOrDefault(col, "") ?? "";
                    }
                    <thead>
                        <tr>
                            @if (Model.HasGrouping)
                            {
                                <th class="@SortClass("GroupName")" onclick="sortBy('GroupName')">
                                    @Model.GroupBy<i class="bi @SortIcon("GroupName") sort-icon"></i>
                                </th>
                            }
                            @if (Model.HasSecondaryGrouping)
                            {
                                <th>@Model.SecondaryGroupBy</th>
                            }
                            <th data-col="Period" class="@SortClass("Period")" onclick="sortBy('Period')">
                                Period<i class="bi @SortIcon("Period") sort-icon"></i>
                            </th>
                            <th data-col="Invoices" class="text-end @SortClass("Invoices")" onclick="sortBy('Invoices')">
                                Invoices<i class="bi @SortIcon("Invoices") sort-icon"></i>
                            </th>
                            <th data-col="Returns" class="text-end @SortClass("Returns")" onclick="sortBy('Returns')">
                                Returns<i class="bi @SortIcon("Returns") sort-icon"></i>
                            </th>
                            <th data-col="NetTransactions" class="text-end @SortClass("NetTransactions")" onclick="sortBy('NetTransactions')">
                                Net Trans.<i class="bi @SortIcon("NetTransactions") sort-icon"></i>
                            </th>
                            <th data-col="QtySold" class="text-end @SortClass("QtySold")" onclick="sortBy('QtySold')">
                                Qty Sold<i class="bi @SortIcon("QtySold") sort-icon"></i>
                            </th>
                            <th data-col="QtyReturned" class="text-end @SortClass("QtyReturned")" onclick="sortBy('QtyReturned')">
                                Qty Ret.<i class="bi @SortIcon("QtyReturned") sort-icon"></i>
                            </th>
                            <th data-col="NetQty" class="text-end @SortClass("NetQty")" onclick="sortBy('NetQty')">
                                Net Qty<i class="bi @SortIcon("NetQty") sort-icon"></i>
                            </th>
                            <th data-col="Sales" class="text-end @SortClass("Sales")" onclick="sortBy('Sales')">
                                @(Model.IncludeVat ? "Gross" : "Net") Sales<i class="bi @SortIcon("Sales") sort-icon"></i>
                            </th>
                            <th data-col="AvgBasket" class="text-end @SortClass("AvgBasket")" onclick="sortBy('AvgBasket')">
                                Avg Basket<i class="bi @SortIcon("AvgBasket") sort-icon"></i>
                            </th>
                            <th data-col="AvgQty" class="text-end @SortClass("AvgQty")" onclick="sortBy('AvgQty')">
                                Avg Qty<i class="bi @SortIcon("AvgQty") sort-icon"></i>
                            </th>
                            @if (Model.CompareLastYear)
                            {
                                <th class="text-end">LY Sales</th>
                                <th class="text-end">LY Avg</th>
                                <th class="text-end">YoY %</th>
                            }
                        </tr>
                        <tr class="filter-row">
                            @if (Model.HasGrouping)
                            {
                                <td>
                                    <div class="filter-cell">
                                        @Html.Raw("<select class=\"filter-op text-filter-op\" data-col=\"GroupName\" onchange=\"applyColumnFilters()\" title=\"Filter mode\"><option value=\"contains\">Contains</option><option value=\"eq\">Equals</option><option value=\"starts\">Starts with</option><option value=\"neq\">Not equal</option></select>")
                                        <input type="text" class="filter-input col-filter" data-col="GroupName"
                                               value="@FilterVal("GroupName")" placeholder="Search..." />
                                    </div>
                                </td>
                            }
                            @if (Model.HasSecondaryGrouping)
                            {
                                <td>
                                    <div class="filter-cell">
                                        @Html.Raw("<select class=\"filter-op text-filter-op\" data-col=\"Group2Name\" onchange=\"applyColumnFilters()\" title=\"Filter mode\"><option value=\"contains\">Contains</option><option value=\"eq\">Equals</option><option value=\"starts\">Starts with</option><option value=\"neq\">Not equal</option></select>")
                                        <input type="text" class="filter-input col-filter" data-col="Group2Name"
                                               value="@FilterVal("Group2Name")" placeholder="Search..." />
                                    </div>
                                </td>
                            }
                            <td>
                                <div class="filter-cell">
                                    @Html.Raw("<select class=\"filter-op text-filter-op\" data-col=\"Period\" onchange=\"applyColumnFilters()\" title=\"Filter mode\"><option value=\"contains\">Contains</option><option value=\"eq\">Equals</option><option value=\"starts\">Starts with</option><option value=\"neq\">Not equal</option></select>")
                                    <input type="text" class="filter-input col-filter" data-col="Period"
                                           value="@FilterVal("Period")" placeholder="Search..." />
                                </div>
                            </td>
                            @{
                                var numColNames = new[] { "Invoices", "Returns", "NetTransactions", "QtySold", "QtyReturned", "NetQty", "Sales", "AvgBasket", "AvgQty" };
                            }
                            @foreach (var colName in numColNames)
                            {
                                <td>
                                    <div class="filter-cell">
                                        @Html.Raw($"<select class=\"filter-op num-filter-op\" data-col=\"{colName}\" onchange=\"applyColumnFilters()\" title=\"Filter mode\"><option value=\"gte\">≥ Min</option><option value=\"eq\">= Equal</option><option value=\"neq\">≠ Not</option><option value=\"gt\">&gt; Greater</option><option value=\"lt\">&lt; Less</option><option value=\"lte\">≤ Max</option></select>")
                                        <input type="text" class="filter-input col-filter" data-col="@colName"
                                               value="@FilterVal(colName)" placeholder="0" inputmode="decimal" />
                                    </div>
                                </td>
                            }
                            @if (Model.CompareLastYear)
                            {
                                <td></td>
                                <td></td>
                                <td></td>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var baseColumnCount = 10 + (Model.CompareLastYear ? 3 : 0);
                            var totalColumns = baseColumnCount + (Model.HasGrouping ? 1 : 0) + (Model.HasSecondaryGrouping ? 1 : 0);
                        }
                        @if (Model.HasGrouping)
                        {
                            var groupedResults = Model.Results
                                .GroupBy(r => r.Level1Value ?? r.Level1 ?? "N/A")
                                .ToList();
                            foreach (var group in groupedResults)
                            {
                                var groupRows = group.ToList();
                                <tr class="group-header-row">
                                    <td colspan="@totalColumns">
                                        <i class="bi bi-diagram-3 me-2"></i>@group.Key
                                    </td>
                                </tr>
                                foreach (var row in groupRows)
                                {
                                    var avgBasket = Model.IncludeVat ? row.CYAverageGross : row.CYAverageNet;
                                    var totalSales = Model.IncludeVat ? row.CYTotalGross : row.CYTotalNet;
                                    <tr>
                                        @if (Model.HasGrouping)
                                        {
                                            <td class="text-info fw-semibold">@((row.Level1Value ?? row.Level1 ?? "N/A"))</td>
                                        }
                                        @if (Model.HasSecondaryGrouping)
                                        {
                                            <td class="text-info">@(row.Level2Value ?? row.Level2 ?? "N/A")</td>
                                        }
                                        <td class="fw-semibold">@row.Period</td>
                                        <td class="text-end">@row.CYInvoiceCount.ToString("N0")</td>
                                        <td class="text-end text-danger">@row.CYCreditCount.ToString("N0")</td>
                                        <td class="text-end fw-semibold">@row.CYTotalTransactions.ToString("N0")</td>
                                        <td class="text-end">@row.CYQtySold.ToString("N0")</td>
                                        <td class="text-end text-danger">@row.CYQtyReturned.ToString("N0")</td>
                                        <td class="text-end fw-semibold">@row.CYTotalQty.ToString("N0")</td>
                                        <td class="text-end">@totalSales.ToString("N2")</td>
                                        <td class="text-end fw-semibold text-primary">@avgBasket.ToString("N2")</td>
                                        <td class="text-end">@row.CYAverageQty.ToString("N2")</td>
                                        @if (Model.CompareLastYear)
                                        {
                                            var lySales = Model.IncludeVat ? row.LYTotalGross : row.LYTotalNet;
                                            var lyAvg = Model.IncludeVat ? row.LYAverageGross : row.LYAverageNet;
                                            var yoyRowClass = row.YoYChangePercent >= 0 ? "text-success" : "text-danger";
                                            var yoyRowIcon = row.YoYChangePercent >= 0 ? "bi-arrow-up" : "bi-arrow-down";
                                            <td class="text-end text-muted">@lySales.ToString("N2")</td>
                                            <td class="text-end text-muted">@lyAvg.ToString("N2")</td>
                                            <td class="text-end @yoyRowClass"><i class="bi @yoyRowIcon"></i> @row.YoYChangePercent.ToString("N1")%</td>
                                        }
                                    </tr>
                                }

                                var gInvoices = groupRows.Sum(r => r.CYInvoiceCount);
                                var gCredits = groupRows.Sum(r => r.CYCreditCount);
                                var gNetTransactions = groupRows.Sum(r => r.CYTotalTransactions);
                                var gQtySold = groupRows.Sum(r => r.CYQtySold);
                                var gQtyReturned = groupRows.Sum(r => r.CYQtyReturned);
                                var gNetQty = groupRows.Sum(r => r.CYTotalQty);
                                var gSales = groupRows.Sum(r => Model.IncludeVat ? r.CYTotalGross : r.CYTotalNet);
                                var gAvgBasket = gNetTransactions > 0 ? gSales / gNetTransactions : 0;
                                var gAvgQty = gNetTransactions > 0 ? gNetQty / gNetTransactions : 0;
                                decimal gLySales = 0, gLyAvg = 0, gYoY = 0;
                                if (Model.CompareLastYear)
                                {
                                    var gLyTransactions = groupRows.Sum(r => r.LYTotalTransactions);
                                    gLySales = groupRows.Sum(r => Model.IncludeVat ? r.LYTotalGross : r.LYTotalNet);
                                    gLyAvg = gLyTransactions > 0 ? gLySales / gLyTransactions : 0;
                                    gYoY = gLySales != 0 ? Math.Round((gSales - gLySales) / Math.Abs(gLySales) * 100, 2) : (gSales > 0 ? 100 : 0);
                                }

                                <tr class="group-subtotal-row">
                                    @if (Model.HasGrouping)
                                    {
                                        <td></td>
                                    }
                                    @if (Model.HasSecondaryGrouping)
                                    {
                                        <td></td>
                                    }
                                    <td class="fw-semibold text-uppercase text-muted">Subtotal</td>
                                    <td class="text-end fw-semibold">@gInvoices.ToString("N0")</td>
                                    <td class="text-end text-danger fw-semibold">@gCredits.ToString("N0")</td>
                                    <td class="text-end fw-semibold">@gNetTransactions.ToString("N0")</td>
                                    <td class="text-end fw-semibold">@gQtySold.ToString("N0")</td>
                                    <td class="text-end text-danger fw-semibold">@gQtyReturned.ToString("N0")</td>
                                    <td class="text-end fw-semibold">@gNetQty.ToString("N0")</td>
                                    <td class="text-end fw-semibold">@gSales.ToString("N2")</td>
                                    <td class="text-end fw-semibold text-primary">@gAvgBasket.ToString("N2")</td>
                                    <td class="text-end fw-semibold">@gAvgQty.ToString("N2")</td>
                                    @if (Model.CompareLastYear)
                                    {
                                        var yoyClass = gYoY >= 0 ? "text-success" : "text-danger";
                                        var yoyIcon = gYoY >= 0 ? "bi-arrow-up" : "bi-arrow-down";
                                        <td class="text-end text-muted fw-semibold">@gLySales.ToString("N2")</td>
                                        <td class="text-end text-muted fw-semibold">@gLyAvg.ToString("N2")</td>
                                        <td class="text-end fw-semibold @yoyClass"><i class="bi @yoyIcon"></i> @gYoY.ToString("N1")%</td>
                                    }
                                </tr>
                            }
                        }
                        else
                        {
                            foreach (var row in Model.Results)
                            {
                                var avgBasket = Model.IncludeVat ? row.CYAverageGross : row.CYAverageNet;
                                var totalSales = Model.IncludeVat ? row.CYTotalGross : row.CYTotalNet;
                                <tr>
                                    @if (Model.HasGrouping)
                                    {
                                        <td class="fw-semibold text-info">@(row.Level1Value ?? row.Level1 ?? "N/A")</td>
                                    }
                                    @if (Model.HasSecondaryGrouping)
                                    {
                                        <td class="text-info">@(row.Level2Value ?? row.Level2 ?? "N/A")</td>
                                    }
                                    <td class="fw-semibold">@row.Period</td>
                                    <td class="text-end">@row.CYInvoiceCount.ToString("N0")</td>
                                    <td class="text-end text-danger">@row.CYCreditCount.ToString("N0")</td>
                                    <td class="text-end fw-semibold">@row.CYTotalTransactions.ToString("N0")</td>
                                    <td class="text-end">@row.CYQtySold.ToString("N0")</td>
                                    <td class="text-end text-danger">@row.CYQtyReturned.ToString("N0")</td>
                                    <td class="text-end fw-semibold">@row.CYTotalQty.ToString("N0")</td>
                                    <td class="text-end">@totalSales.ToString("N2")</td>
                                    <td class="text-end fw-semibold text-primary">@avgBasket.ToString("N2")</td>
                                    <td class="text-end">@row.CYAverageQty.ToString("N2")</td>
                                    @if (Model.CompareLastYear)
                                    {
                                        var lySales = Model.IncludeVat ? row.LYTotalGross : row.LYTotalNet;
                                        var lyAvg = Model.IncludeVat ? row.LYAverageGross : row.LYAverageNet;
                                        var yoyRowClass = row.YoYChangePercent >= 0 ? "text-success" : "text-danger";
                                        var yoyRowIcon = row.YoYChangePercent >= 0 ? "bi-arrow-up" : "bi-arrow-down";
                                        <td class="text-end text-muted">@lySales.ToString("N2")</td>
                                        <td class="text-end text-muted">@lyAvg.ToString("N2")</td>
                                        <td class="text-end @yoyRowClass"><i class="bi @yoyRowIcon"></i> @row.YoYChangePercent.ToString("N1")%</td>
                                    }
                                </tr>
                            }
                        }
                    </tbody>
                    <tfoot>
                        @if (Model.TotalPages > 1)
                        {
                            <tr class="table-light fw-bold">
                                @if (Model.HasGrouping) { <td></td> }
                                @if (Model.HasSecondaryGrouping) { <td></td> }
                                <td>PAGE TOTAL</td>
                                <td class="text-end">@Model.Results.Sum(r => r.CYInvoiceCount).ToString("N0")</td>
                                <td class="text-end text-danger">@Model.Results.Sum(r => r.CYCreditCount).ToString("N0")</td>
                                <td class="text-end">@Model.TotalTransactions.ToString("N0")</td>
                                <td class="text-end">@Model.Results.Sum(r => r.CYQtySold).ToString("N0")</td>
                                <td class="text-end text-danger">@Model.Results.Sum(r => r.CYQtyReturned).ToString("N0")</td>
                                <td class="text-end">@Model.TotalQty.ToString("N0")</td>
                                <td class="text-end">@((Model.IncludeVat ? Model.TotalGrossSales : Model.TotalNetSales).ToString("N2"))</td>
                                <td class="text-end text-primary">@Model.OverallAverageBasket.ToString("N2")</td>
                                <td class="text-end">-</td>
                                @if (Model.CompareLastYear)
                                {
                                    var footYoyClass = Model.OverallYoYChangePercent >= 0 ? "text-success" : "text-danger";
                                    var footYoyIcon = Model.OverallYoYChangePercent >= 0 ? "bi-arrow-up" : "bi-arrow-down";
                                    <td class="text-end text-muted">@((Model.IncludeVat ? Model.TotalLYGrossSales : Model.TotalLYNetSales).ToString("N2"))</td>
                                    <td class="text-end">-</td>
                                    <td class="text-end @footYoyClass"><i class="bi @footYoyIcon"></i> @Model.OverallYoYChangePercent.ToString("N1")%</td>
                                }
                            </tr>
                        }
                        @if (Model.GrandTotals != null)
                        {
                            var gt = Model.GrandTotals;
                            var gtSales = Model.IncludeVat ? gt.GrossSales : gt.NetSales;
                            var gtAvg = Model.IncludeVat ? gt.AverageBasketGross : gt.AverageBasketNet;
                            <tr class="grand-total-row">
                                @if (Model.HasGrouping) { <td></td> }
                                @if (Model.HasSecondaryGrouping) { <td></td> }
                                <td><i class="bi bi-calculator me-1"></i>GRAND TOTAL</td>
                                <td class="text-end">@gt.TotalInvoices.ToString("N0")</td>
                                <td class="text-end text-danger">@gt.TotalCredits.ToString("N0")</td>
                                <td class="text-end">@gt.NetTransactions.ToString("N0")</td>
                                <td class="text-end">@gt.TotalQtySold.ToString("N0")</td>
                                <td class="text-end text-danger">@gt.TotalQtyReturned.ToString("N0")</td>
                                <td class="text-end">@gt.NetQty.ToString("N0")</td>
                                <td class="text-end">@gtSales.ToString("N2")</td>
                                <td class="text-end text-primary">@gtAvg.ToString("N2")</td>
                                <td class="text-end">@gt.AverageQty.ToString("N2")</td>
                                @if (Model.CompareLastYear)
                                {
                                    var gtLySales = Model.IncludeVat ? gt.LYTotalGross : gt.LYTotalNet;
                                    var gtLyAvg = Model.IncludeVat ? gt.LYAverageBasketGross : gt.LYAverageBasketNet;
                                    var gtYoyClass = gt.YoYChangePercent >= 0 ? "text-success" : "text-danger";
                                    var gtYoyIcon = gt.YoYChangePercent >= 0 ? "bi-arrow-up" : "bi-arrow-down";
                                    <td class="text-end">@gtLySales.ToString("N2")</td>
                                    <td class="text-end">@gtLyAvg.ToString("N2")</td>
                                    <td class="text-end @gtYoyClass"><i class="bi @gtYoyIcon"></i> @gt.YoYChangePercent.ToString("N1")%</td>
                                }
                            </tr>
                        }
                    </tfoot>
                </table>
            </div>
        </div>
        
        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-muted">
                        Showing @((Model.PageNumber - 1) * Model.PageSize + 1) to @(Math.Min(Model.PageNumber * Model.PageSize, Model.TotalCount)) of @Model.TotalCount rows
                    </div>
                    <nav>
                        <ul class="pagination mb-0">
                            <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
                                <a class="page-link" href="#" onclick="goToPage(1); return false;">
                                    <i class="bi bi-chevron-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
                                <a class="page-link" href="#" onclick="goToPage(@(Model.PageNumber - 1)); return false;">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            
                            @{
                                var startPage = Math.Max(1, Model.PageNumber - 2);
                                var endPage = Math.Min(Model.TotalPages, Model.PageNumber + 2);
                            }
                            
                            @for (int p = startPage; p <= endPage; p++)
                            {
                                <li class="page-item @(p == Model.PageNumber ? "active" : "")">
                                    <a class="page-link" href="#" onclick="goToPage(@p); return false;">@p</a>
                                </li>
                            }
                            
                            <li class="page-item @(Model.HasNextPage ? "" : "disabled")">
                                <a class="page-link" href="#" onclick="goToPage(@(Model.PageNumber + 1)); return false;">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            <li class="page-item @(Model.HasNextPage ? "" : "disabled")">
                                <a class="page-link" href="#" onclick="goToPage(@Model.TotalPages); return false;">
                                    <i class="bi bi-chevron-double-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        }
    </div>

    <!-- Inline Preview Panel (hidden by default) -->
    <div id="previewPanel" style="display:none;" class="mt-3">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center py-2">
                <span><i class="bi bi-file-earmark-text me-2"></i>Document Preview</span>
                <button class="btn btn-sm btn-outline-light" onclick="togglePreview()" title="Close preview">
                    <i class="bi bi-x-lg me-1"></i>Back to Grid
                </button>
            </div>
            <div class="card-body p-0">
                <iframe id="previewFrame" style="width:100%; border:none; min-height:700px; background:#525659;"></iframe>
            </div>
        </div>
    </div>
}
else if (ViewContext.HttpContext.Request.Method == "POST")
{
    <div class="card" id="results">
        <div class="card-body text-center py-5">
            <i class="bi bi-inbox empty-state-icon text-muted"></i>
            <h4 class="mt-3">No Data Found</h4>
            <p class="text-muted">No transactions found for the selected criteria.</p>
            <div class="mt-4 d-flex justify-content-center gap-2 flex-wrap">
                @if (hasAnyFilter)
                {
                    <button class="btn btn-outline-warning" onclick="clearAllFilters()" title="Clear column filter inputs and refresh">
                        <i class="bi bi-funnel me-1"></i>Clear column filters
                    </button>
                }
                <a asp-action="AverageBasket" asp-route-clearedFilters="true" class="btn btn-outline-secondary" title="Clear filters and reload. Your saved layout is preserved.">
                    <i class="bi bi-funnel me-1"></i>Clear Filters
                </a>
            </div>
        </div>
    </div>
}
else
{
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="bi bi-bar-chart empty-state-icon text-primary"></i>
            <h4 class="mt-3">Generate Your Report</h4>
            <p class="text-muted">Select your parameters above and click "Generate Report" to view the Average Basket analysis.</p>
        </div>
    </div>
}

<!-- Items Selection Modal -->
<div class="modal fade" id="itemsModal" tabindex="-1" aria-labelledby="itemsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="itemsModalLabel">
                    <i class="bi bi-box-seam me-2"></i>Select Items
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">Items load automatically. Type to search by code or name in real time.</p>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="itemSearchInput" placeholder="Search by code or name (filters as you type)..." aria-label="Search items" onkeydown="if(event.key==='Enter'){event.preventDefault();searchItems();}">
                    <div class="form-check form-check-inline ms-2 align-self-center">
                        <input class="form-check-input" type="checkbox" id="itemSearchIncludeInactive" />
                        <label class="form-check-label small" for="itemSearchIncludeInactive">Include inactive</label>
                    </div>
                    <button type="button" class="btn btn-primary" id="itemSearchBtn" onclick="searchItems()">
                        <i class="bi bi-search me-1"></i>Search
                    </button>
                </div>
                <div id="itemSearchStatus" class="small text-muted mb-2"></div>
                <div class="item-results-container border rounded" style="max-height: 320px; overflow-y: auto;">
                    <div id="itemResultsList" class="list-group list-group-flush">
                        <div class="list-group-item text-muted text-center py-4" id="itemResultsPlaceholder">
                            Type a search term (or leave empty for all) and click Search
                        </div>
                    </div>
                </div>
                <div class="mt-2 small">
                    <strong>Selected:</strong> <span id="itemSelectedCount">0</span> items
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectAllItemsInModal()">Select All</button>
                <button type="button" class="btn btn-outline-secondary" onclick="clearItemsInModal()">Clear Selection</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="applyItemSelection()" data-bs-dismiss="modal">
                    <i class="bi bi-check-lg me-1"></i>Apply
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scheduleModalLabel">
                    <i class="bi bi-clock-history me-2"></i>Schedule Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-light border mb-3 py-2">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        The report will run automatically and recipients will receive an email with a link to download the exported file.
                    </small>
                </div>

                <h6 class="text-muted mb-2"><i class="bi bi-funnel me-1"></i>Parameters (current selection)</h6>
                <div class="bg-light rounded p-2 mb-4 small">
                    <span class="me-3"><strong>Period:</strong> @Model.DateFrom.ToString("dd/MM/yyyy") – @Model.DateTo.ToString("dd/MM/yyyy")</span>
                    <span class="me-3"><strong>Breakdown:</strong> @Model.Breakdown</span>
                    @if (Model.HasStoreFilter)
                    {
                        <span class="me-3"><strong>Stores:</strong> @Model.SelectedStoreCodes.Count selected</span>
                    }
                    @if (Model.HasItemFilter)
                    {
                        <span><strong>Items:</strong> @Model.SelectedItemIds.Count selected</span>
                    }
                </div>

                <h6 class="text-muted mb-2"><i class="bi bi-gear me-1"></i>Schedule settings</h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Schedule Name</label>
                        <input type="text" class="form-control" id="schedName" placeholder="e.g. Weekly Sales Summary" required>
                        <small class="text-muted">A label to identify this schedule in the list</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Export Format</label>
                        <select class="form-select" id="schedFormat">
                            <option value="Excel">Excel (.xlsx)</option>
                            <option value="PDF">PDF</option>
                            <option value="CSV">CSV</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Recurrence</label>
                        <select class="form-select" id="schedRecurrence" onchange="onRecurrenceChange()">
                            <option value="Once">Run Once</option>
                            <option value="Daily" selected>Daily</option>
                            <option value="Weekly">Weekly</option>
                            <option value="Monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="col-md-4" id="schedDayContainer" style="display:none;">
                        <label class="form-label fw-semibold" id="schedDayLabel">Day</label>
                        <select class="form-select" id="schedDay">
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                            <option value="0">Sunday</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Time</label>
                        <input type="time" class="form-control" id="schedTime" value="08:00">
                    </div>

                    <div class="col-12 mt-2">
                        <h6 class="text-muted mb-2"><i class="bi bi-envelope me-1"></i>Recipients</h6>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-semibold">Email addresses</label>
                        <input type="text" class="form-control" id="schedRecipients" placeholder="user@company.com, manager@company.com">
                        <small class="text-muted">Separate multiple addresses with commas</small>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-semibold">Email Subject <span class="text-muted fw-normal">(optional)</span></label>
                        <input type="text" class="form-control" id="schedSubject" placeholder="Average Basket Report - {date}">
                    </div>
                </div>
                <div id="scheduleAlert" class="mt-3" style="display:none;"></div>

                <hr class="my-3">
                <h6 class="text-muted"><i class="bi bi-list-check me-1"></i>Existing Schedules</h6>
                <div id="existingSchedules" class="small text-muted">Loading...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSchedule()">
                    <i class="bi bi-check-lg me-1"></i>Save Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Column Settings Modal -->
<div class="modal fade" id="columnSettingsModal" tabindex="-1" aria-labelledby="columnSettingsLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="columnSettingsLabel">
                    <i class="bi bi-layout-three-columns me-2"></i>Column Visibility
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3">Toggle which data columns are visible in the results table. Changes apply immediately.</p>
                <div class="row g-2">
                    <div class="col-6"><div class="form-check"><input class="form-check-input col-toggle" type="checkbox" value="Invoices" id="colToggleInvoices" checked onchange="applyColumnVisibility()"><label class="form-check-label" for="colToggleInvoices">Invoices</label></div></div>
                    <div class="col-6"><div class="form-check"><input class="form-check-input col-toggle" type="checkbox" value="Returns" id="colToggleReturns" checked onchange="applyColumnVisibility()"><label class="form-check-label" for="colToggleReturns">Returns</label></div></div>
                    <div class="col-6"><div class="form-check"><input class="form-check-input col-toggle" type="checkbox" value="NetTransactions" id="colToggleNetTransactions" checked onchange="applyColumnVisibility()"><label class="form-check-label" for="colToggleNetTransactions">Net Transactions</label></div></div>
                    <div class="col-6"><div class="form-check"><input class="form-check-input col-toggle" type="checkbox" value="QtySold" id="colToggleQtySold" checked onchange="applyColumnVisibility()"><label class="form-check-label" for="colToggleQtySold">Qty Sold</label></div></div>
                    <div class="col-6"><div class="form-check"><input class="form-check-input col-toggle" type="checkbox" value="QtyReturned" id="colToggleQtyReturned" checked onchange="applyColumnVisibility()"><label class="form-check-label" for="colToggleQtyReturned">Qty Returned</label></div></div>
                    <div class="col-6"><div class="form-check"><input class="form-check-input col-toggle" type="checkbox" value="NetQty" id="colToggleNetQty" checked onchange="applyColumnVisibility()"><label class="form-check-label" for="colToggleNetQty">Net Qty</label></div></div>
                    <div class="col-6"><div class="form-check"><input class="form-check-input col-toggle" type="checkbox" value="Sales" id="colToggleSales" checked onchange="applyColumnVisibility()"><label class="form-check-label" for="colToggleSales">Sales</label></div></div>
                    <div class="col-6"><div class="form-check"><input class="form-check-input col-toggle" type="checkbox" value="AvgBasket" id="colToggleAvgBasket" checked onchange="applyColumnVisibility()"><label class="form-check-label" for="colToggleAvgBasket">Avg Basket</label></div></div>
                    <div class="col-6"><div class="form-check"><input class="form-check-input col-toggle" type="checkbox" value="AvgQty" id="colToggleAvgQty" checked onchange="applyColumnVisibility()"><label class="form-check-label" for="colToggleAvgQty">Avg Qty</label></div></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="resetColumnVisibility()">Show All</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Done</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
// Store selection functionality
let storeDropdownOpen = false;

function toggleStoreDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('storeDropdown');
    const selector = document.getElementById('storeSelector');
    storeDropdownOpen = !storeDropdownOpen;
    dropdown.classList.toggle('show', storeDropdownOpen);
    selector.setAttribute('aria-expanded', storeDropdownOpen);
}

document.addEventListener('click', function(event) {
    const container = document.querySelector('.store-select-container');
    if (!container.contains(event.target)) {
        const dropdown = document.getElementById('storeDropdown');
        const selector = document.getElementById('storeSelector');
        dropdown.classList.remove('show');
        selector.setAttribute('aria-expanded', 'false');
        storeDropdownOpen = false;
    }
});

function updateStoreSelection() {
    const checkboxes = document.querySelectorAll('#storeList input[type="checkbox"]:checked');
    const selectedCodes = Array.from(checkboxes).map(cb => cb.value);
    
    document.getElementById('selectedStoreCodesHidden').value = selectedCodes.join(',');
    
    const text = selectedCodes.length === 0 
        ? 'All Stores' 
        : selectedCodes.length === 1 
            ? `1 store selected`
            : `${selectedCodes.length} stores selected`;
    
    document.getElementById('storeSelectionText').textContent = text;
}

function selectAllStores() {
    document.querySelectorAll('#storeList input[type="checkbox"]').forEach(cb => cb.checked = true);
    updateStoreSelection();
}

function clearStoreSelection() {
    document.querySelectorAll('#storeList input[type="checkbox"]').forEach(cb => cb.checked = false);
    updateStoreSelection();
}

function filterStores() {
    const searchText = document.getElementById('storeSearchInput').value.toLowerCase();
    document.querySelectorAll('.store-item').forEach(item => {
        const name = item.dataset.name;
        const code = item.dataset.code.toLowerCase();
        const visible = name.includes(searchText) || code.includes(searchText);
        item.style.display = visible ? 'flex' : 'none';
    });
}

// Items selection
let itemModalSelectedIds = new Set();
var _itemSearchDebounceTimer = null;
var ITEM_SEARCH_DEBOUNCE_MS = 350;

function openItemsModal() {
    itemModalSelectedIds = new Set(
        (document.getElementById('selectedItemIdsHidden').value || '')
            .split(',').map(s => parseInt(s, 10)).filter(n => !isNaN(n))
    );
    document.getElementById('itemSearchInput').value = '';
    document.getElementById('itemSearchIncludeInactive').checked = false;
    document.getElementById('itemResultsList').innerHTML = '<div class="list-group-item text-muted text-center py-4" id="itemResultsPlaceholder"><span class="spinner-border spinner-border-sm me-2"></span>Loading items...</div>';
    document.getElementById('itemSearchStatus').textContent = '';
    updateItemSelectedCount();
    var modalEl = document.getElementById('itemsModal');
    var modal = new bootstrap.Modal(modalEl);
    modalEl.addEventListener('shown.bs.modal', function onShown() {
        modalEl.removeEventListener('shown.bs.modal', onShown);
        searchItems();
    }, { once: true });
    modal.show();
}

function searchItems() {
    const search = document.getElementById('itemSearchInput').value.trim();
    const includeInactive = document.getElementById('itemSearchIncludeInactive').checked;
    const statusEl = document.getElementById('itemSearchStatus');
    const listEl = document.getElementById('itemResultsList');

    statusEl.textContent = 'Searching...';
    listEl.innerHTML = '';

    const url = '@Url.Action("SearchItems", "Reports")' +
        '?search=' + encodeURIComponent(search) +
        '&includeInactive=' + (includeInactive ? 'true' : 'false');

    fetch(url)
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                statusEl.textContent = data.error;
                return;
            }
            if (!data || data.length === 0) {
                statusEl.textContent = 'No items found.';
                listEl.innerHTML = '<div class="list-group-item text-muted text-center py-4">No items found</div>';
                return;
            }
            statusEl.textContent = data.length + ' item(s) found.';
            function esc(s) { return (s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
            listEl.innerHTML = data.map(i => {
                const checked = itemModalSelectedIds.has(i.id) ? 'checked' : '';
                return '<label class="list-group-item list-group-item-action d-flex align-items-center">' +
                    '<input type="checkbox" class="form-check-input me-2" value="' + i.id + '" ' + checked + ' onchange="toggleItemInModal(' + i.id + ')">' +
                    '<span><strong>' + esc(i.code) + '</strong> - ' + esc(i.name) + '</span></label>';
            }).join('');
        })
        .catch(() => {
            statusEl.textContent = 'Search failed. Please try again.';
        });
}

function toggleItemInModal(id) {
    if (itemModalSelectedIds.has(id))
        itemModalSelectedIds.delete(id);
    else
        itemModalSelectedIds.add(id);
    updateItemSelectedCount();
}

function updateItemSelectedCount() {
    document.getElementById('itemSelectedCount').textContent = itemModalSelectedIds.size;
}

function selectAllItemsInModal() {
    document.querySelectorAll('#itemResultsList input[type="checkbox"]').forEach(function(cb) {
        cb.checked = true;
        itemModalSelectedIds.add(parseInt(cb.value, 10));
    });
    updateItemSelectedCount();
}

function clearItemsInModal() {
    itemModalSelectedIds.clear();
    document.querySelectorAll('#itemResultsList input[type="checkbox"]').forEach(cb => cb.checked = false);
    updateItemSelectedCount();
}

function applyItemSelection() {
    const ids = Array.from(itemModalSelectedIds);
    document.getElementById('selectedItemIdsHidden').value = ids.join(',');
    updateItemSelectionText();
}

function clearItemSelection() {
    document.getElementById('selectedItemIdsHidden').value = '';
    updateItemSelectionText();
}

function updateItemSelectionText() {
    const val = document.getElementById('selectedItemIdsHidden').value;
    const count = val ? val.split(',').filter(s => s.trim()).length : 0;
    document.getElementById('itemSelectionText').textContent =
        count === 0 ? 'All Items' : count === 1 ? '1 item selected' : count + ' items selected';
}

// Date preset handling
function clearPreset() {
    document.querySelectorAll('input[name="DatePreset"]').forEach(r => r.checked = false);
}

function applyPresetDates(preset) {
    const today = new Date();
    let from, to;
    let breakdown = null;

    switch (preset) {
        case 'today':
            from = to = today;
            breakdown = 'Daily';
            break;
        case 'yesterday':
            from = to = addDays(today, -1);
            breakdown = 'Daily';
            break;
        case 'last7':
            from = addDays(today, -6);
            to = today;
            breakdown = 'Daily';
            break;
        case 'last30':
            from = addDays(today, -29);
            to = today;
            breakdown = 'Daily';
            break;
        case 'thisMonth':
            from = new Date(today.getFullYear(), today.getMonth(), 1);
            to = today;
            breakdown = 'Daily';
            break;
        case 'lastMonth':
            var lm = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            from = lm;
            to = new Date(lm.getFullYear(), lm.getMonth() + 1, 0);
            breakdown = 'Daily';
            break;
        case 'ytd':
            from = new Date(today.getFullYear(), 0, 1);
            to = today;
            breakdown = 'Monthly';
            break;
        case 'lastYear':
            from = new Date(today.getFullYear() - 1, 0, 1);
            to = new Date(today.getFullYear() - 1, 11, 31);
            breakdown = 'Monthly';
            break;
        default:
            return;
    }

    document.getElementById('DateFrom').value = formatDate(from);
    document.getElementById('DateTo').value = formatDate(to);

    if (breakdown) {
        var sel = document.getElementById('Breakdown');
        for (var i = 0; i < sel.options.length; i++) {
            if (sel.options[i].text === breakdown) { sel.selectedIndex = i; break; }
        }
    }
}

function addDays(date, days) {
    var d = new Date(date);
    d.setDate(d.getDate() + days);
    return d;
}

function formatDate(d) {
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

// Submit form with anchor to keep scroll at results
function submitToResults() {
    var form = document.getElementById('reportForm');
    var action = form.getAttribute('action') || '';
    if (action.indexOf('#') > -1) action = action.substring(0, action.indexOf('#'));
    form.setAttribute('action', action + '#results');
    form.submit();
}

// Column filtering with live debounce
var _filterTimer = null;
var FILTER_DEBOUNCE_MS = 600;

function syncFilterHiddenFields() {
    document.querySelectorAll('.col-filter').forEach(function(input) {
        var col = input.dataset.col;
        var hidden = document.getElementById('fv_' + col);
        if (hidden) hidden.value = input.value.trim();
        // Visual feedback: highlight active filters
        input.classList.toggle('filter-active', input.value.trim() !== '');
    });
    document.querySelectorAll('.filter-op').forEach(function(select) {
        var col = select.dataset.col;
        var hidden = document.getElementById('fo_' + col);
        if (hidden) hidden.value = select.value;
    });
}

function applyColumnFilters() {
    if (_filterTimer) clearTimeout(_filterTimer);
    syncFilterHiddenFields();
    document.getElementById('pageNumberHidden').value = 1;
    submitToResults();
}

function scheduleFilterApply() {
    if (_filterTimer) clearTimeout(_filterTimer);
    _filterTimer = setTimeout(function() {
        applyColumnFilters();
    }, FILTER_DEBOUNCE_MS);
}

function clearAllFilters() {
    if (_filterTimer) clearTimeout(_filterTimer);
    document.querySelectorAll('.col-filter').forEach(function(input) {
        input.value = '';
        input.classList.remove('filter-active');
    });
    document.querySelectorAll('.filter-op').forEach(function(select) { select.selectedIndex = 0; });
    @foreach (var col in filterCols)
    {
        @:document.getElementById('fv_@col').value = '';
        @:document.getElementById('fo_@col').value = '';
    }
    document.getElementById('pageNumberHidden').value = 1;
    submitToResults();
}

// Column sorting
function sortBy(column) {
    var currentCol = document.getElementById('sortColumnHidden').value;
    var currentDir = document.getElementById('sortDirectionHidden').value;
    
    if (currentCol === column) {
        document.getElementById('sortDirectionHidden').value = (currentDir === 'ASC') ? 'DESC' : 'ASC';
    } else {
        document.getElementById('sortColumnHidden').value = column;
        document.getElementById('sortDirectionHidden').value = 'ASC';
    }
    
    document.getElementById('pageNumberHidden').value = 1;
    submitToResults();
}

// Pagination
function goToPage(page) {
    document.getElementById('pageNumberHidden').value = page;
    submitToResults();
}

function resetPage() {
    document.getElementById('pageNumberHidden').value = 1;
}

function showLoading() {
    const btn = document.getElementById('generateBtn');
    const spinner = btn.querySelector('.spinner-border');
    const text = btn.querySelector('.btn-text');
    
    btn.classList.add('btn-loading');
    spinner.classList.remove('d-none');
    text.style.visibility = 'hidden';
    
    // Disable after a tiny delay to allow form submission
    setTimeout(() => { btn.disabled = true; }, 10);
}

// Print Preview toggle
var previewOpen = false;
function togglePreview() {
    var panel = document.getElementById('previewPanel');
    var gridCard = document.getElementById('results');
    var btn = document.getElementById('previewToggleBtn');
    previewOpen = !previewOpen;

    if (previewOpen) {
        gridCard.style.display = 'none';
        panel.style.display = 'block';
        btn.innerHTML = '<i class="bi bi-table me-1"></i>Grid';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-outline-warning');

        var frame = document.getElementById('previewFrame');
        if (!frame.src || frame.src === 'about:blank') {
            var url = '@Url.Action("PrintPreview")' +
                '?dateFrom=@Model.DateFrom.ToString("yyyy-MM-dd")' +
                '&dateTo=@Model.DateTo.ToString("yyyy-MM-dd")' +
                '&breakdown=@Model.Breakdown' +
                '&groupBy=@Model.GroupBy' +
                '&secondaryGroupBy=@Model.SecondaryGroupBy' +
                '&includeVat=@Model.IncludeVat' +
                '&compareLastYear=@Model.CompareLastYear' +
                '&storeCodes=@(Model.SelectedStoreCodesString ?? "")' +
                '&itemIds=@(Model.SelectedItemIdsString ?? "")' +
                '&sortColumn=@Model.SortColumn' +
                '&sortDirection=@Model.SortDirection';
            frame.src = url;
        }

        // Auto-resize iframe to content
        frame.onload = function() {
            try {
                var h = frame.contentDocument.body.scrollHeight + 80;
                frame.style.height = Math.max(h, 700) + 'px';
            } catch (e) { frame.style.height = '900px'; }
        };
    } else {
        panel.style.display = 'none';
        gridCard.style.display = '';
        btn.innerHTML = '<i class="bi bi-eye me-1"></i>Preview';
        btn.classList.remove('btn-outline-warning');
        btn.classList.add('btn-outline-primary');
    }
}

// CSV Export
function exportToCSV() {
    const table = document.getElementById('resultsTable');
    let csv = [];
    
    // Headers
    const headers = [];
    table.querySelectorAll('thead th').forEach(th => headers.push('"' + th.textContent.trim() + '"'));
    csv.push(headers.join(','));
    
    // Data rows
    table.querySelectorAll('tbody tr').forEach(row => {
        const rowData = [];
        row.querySelectorAll('td').forEach(td => rowData.push('"' + td.textContent.trim() + '"'));
        csv.push(rowData.join(','));
    });
    
    // Download
    const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `AverageBasket_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
}

    // Schedule modal
function onRecurrenceChange() {
    var type = document.getElementById('schedRecurrence').value;
    var container = document.getElementById('schedDayContainer');
    var daySelect = document.getElementById('schedDay');
    var label = document.getElementById('schedDayLabel');

    if (type === 'Weekly') {
        container.style.display = '';
        label.textContent = 'Day of Week';
        daySelect.innerHTML = '<option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option><option value="0">Sunday</option>';
    } else if (type === 'Monthly') {
        container.style.display = '';
        label.textContent = 'Day of Month';
        var opts = '';
        for (var i = 1; i <= 28; i++) opts += '<option value="' + i + '">' + i + '</option>';
        daySelect.innerHTML = opts;
    } else {
        container.style.display = 'none';
    }
}

function saveSchedule() {
    var name = document.getElementById('schedName').value.trim();
    var recipients = document.getElementById('schedRecipients').value.trim();
    var alertDiv = document.getElementById('scheduleAlert');

    if (!name || !recipients) {
        alertDiv.innerHTML = '<div class="alert alert-warning mb-0">Please fill in schedule name and recipients.</div>';
        alertDiv.style.display = '';
        return;
    }

    var recurrence = document.getElementById('schedRecurrence').value;
    var day = (recurrence === 'Weekly' || recurrence === 'Monthly')
        ? document.getElementById('schedDay').value : null;

    var formData = new FormData();
    formData.append('scheduleName', name);
    formData.append('recurrenceType', recurrence);
    if (day) formData.append('recurrenceDay', day);
    formData.append('scheduleTime', document.getElementById('schedTime').value);
    formData.append('exportFormat', document.getElementById('schedFormat').value);
    formData.append('recipients', recipients);
    formData.append('emailSubject', document.getElementById('schedSubject').value);

    var params = {
        dateFrom: document.getElementById('DateFrom').value,
        dateTo: document.getElementById('DateTo').value,
        breakdown: document.getElementById('Breakdown').value,
        groupBy: document.getElementById('GroupBy').value,
        secondaryGroupBy: document.getElementById('SecondaryGroupBy').value,
        includeVat: document.getElementById('includeVatCheck').checked,
        compareLastYear: document.getElementById('compareLyCheck').checked,
        storeCodes: document.getElementById('selectedStoreCodesHidden').value || '',
        itemIds: document.getElementById('selectedItemIdsHidden').value || '',
        sortColumn: document.getElementById('sortColumnHidden').value || 'Period',
        sortDirection: document.getElementById('sortDirectionHidden').value || 'ASC'
    };
    formData.append('parametersJson', JSON.stringify(params));

    fetch('@Url.Action("SaveSchedule", "Reports")', { method: 'POST', body: formData })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                alertDiv.innerHTML = '<div class="alert alert-success mb-0"><i class="bi bi-check-circle me-1"></i>' + data.message + '</div>';
                alertDiv.style.display = '';
                document.getElementById('schedName').value = '';
                loadExistingSchedules();
            } else {
                alertDiv.innerHTML = '<div class="alert alert-danger mb-0">' + data.message + '</div>';
                alertDiv.style.display = '';
            }
        })
        .catch(function() {
            alertDiv.innerHTML = '<div class="alert alert-danger mb-0">Network error. Please try again.</div>';
            alertDiv.style.display = '';
        });
}

function loadExistingSchedules() {
    fetch('@Url.Action("GetSchedules", "Reports")')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var container = document.getElementById('existingSchedules');
            if (!data || data.length === 0) {
                container.innerHTML = '<em>No schedules configured yet.</em>';
                return;
            }
            var html = '<table class="table table-sm mb-0"><thead><tr><th>Name</th><th>Recurrence</th><th>Format</th><th>Time</th><th>Next Run</th></tr></thead><tbody>';
            data.forEach(function(s) {
                html += '<tr><td>' + s.scheduleName + '</td><td>' + s.recurrenceType + '</td><td>' + s.exportFormat + '</td><td>' + s.scheduleTime + '</td><td>' + (s.nextRun || '-') + '</td></tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        })
        .catch(function() {
            document.getElementById('existingSchedules').innerHTML = '<em>Could not load schedules.</em>';
        });
}

// Load schedules when modal opens
document.addEventListener('DOMContentLoaded', function() {
    var modal = document.getElementById('scheduleModal');
    if (modal) {
        modal.addEventListener('show.bs.modal', loadExistingSchedules);
    }
});

    // Item search: live filter as you type (debounced)
function scheduleItemSearch() {
    if (_itemSearchDebounceTimer) clearTimeout(_itemSearchDebounceTimer);
    _itemSearchDebounceTimer = setTimeout(function() { searchItems(); }, ITEM_SEARCH_DEBOUNCE_MS);
}

// ==================== Layout Save/Load/Reset ====================

function collectCurrentLayout() {
    var parms = {};
    var vat = document.getElementById('includeVatCheck');
    if (vat) parms['IncludeVat'] = vat.checked ? '1' : '0';
    var cly = document.getElementById('compareLyCheck');
    if (cly) parms['CompareLastYear'] = cly.checked ? '1' : '0';
    var bd = document.getElementById('Breakdown');
    if (bd) parms['Breakdown'] = bd.options[bd.selectedIndex].text;
    var gb = document.getElementById('GroupBy');
    if (gb) parms['GroupBy'] = gb.options[gb.selectedIndex].text;
    var sgb = document.getElementById('SecondaryGroupBy');
    if (sgb) parms['SecondaryGroupBy'] = sgb.options[sgb.selectedIndex].text;
    var ps = document.getElementById('PageSize');
    if (ps) parms['PageSize'] = ps.value;

    // Column visibility
    var hidden = [];
    document.querySelectorAll('.col-toggle').forEach(function(cb) {
        if (!cb.checked) hidden.push(cb.value);
    });
    parms['HiddenColumns'] = hidden.join(',');

    return parms;
}

function saveCurrentLayout() {
    var parms = collectCurrentLayout();
    fetch('@Url.Action("SaveLayout", "Reports")', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(parms)
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            showLayoutToast('Layout saved successfully', 'success');
        } else {
            showLayoutToast(data.message || 'Failed to save layout', 'danger');
        }
    })
    .catch(function() {
        showLayoutToast('Network error saving layout', 'danger');
    });
}

function resetSavedLayout() {
    if (!confirm('Reset your saved layout to factory defaults?')) return;
    fetch('@Url.Action("ResetLayout", "Reports")', { method: 'POST' })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            showLayoutToast('Layout reset — reloading...', 'success');
            setTimeout(function() { window.location.href = '@Url.Action("AverageBasket", new { layoutReset = true })'; }, 800);
        } else {
            showLayoutToast(data.message || 'Failed to reset layout', 'danger');
        }
    })
    .catch(function() {
        showLayoutToast('Network error', 'danger');
    });
}

function showLayoutToast(message, type) {
    var existing = document.getElementById('layoutToast');
    if (existing) existing.remove();
    var div = document.createElement('div');
    div.id = 'layoutToast';
    div.className = 'alert alert-' + type + ' alert-dismissible fade show position-fixed bottom-0 end-0 m-3 shadow';
    div.style.zIndex = '9999';
    div.innerHTML = '<i class="bi bi-' + (type === 'success' ? 'check-circle' : 'exclamation-triangle') + ' me-1"></i>' + message +
        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    document.body.appendChild(div);
    setTimeout(function() { if (div.parentNode) div.remove(); }, 4000);
}

// ==================== Column Visibility ====================

function applyColumnVisibility() {
    var hidden = [];
    document.querySelectorAll('.col-toggle').forEach(function(cb) {
        if (!cb.checked) hidden.push(cb.value);
    });
    var hiddenInput = document.getElementById('hiddenColumnsInput');
    if (hiddenInput) hiddenInput.value = hidden.join(',');

    var styleEl = document.getElementById('colVisibilityStyle');
    if (!styleEl) {
        styleEl = document.createElement('style');
        styleEl.id = 'colVisibilityStyle';
        document.head.appendChild(styleEl);
    }

    var table = document.getElementById('resultsTable');
    if (!table) return;

    var rules = [];
    document.querySelectorAll('.col-toggle').forEach(function(cb) {
        var colKey = cb.value;
        if (!cb.checked) {
            var headers = table.querySelectorAll('thead tr:first-child th');
            for (var i = 0; i < headers.length; i++) {
                if (headers[i].getAttribute('data-col') === colKey) {
                    var colIdx = i + 1;
                    rules.push('#resultsTable th:nth-child(' + colIdx + '), #resultsTable td:nth-child(' + colIdx + ') { display: none; }');
                    break;
                }
            }
        }
    });

    styleEl.textContent = rules.join('\n');
}

function resetColumnVisibility() {
    document.querySelectorAll('.col-toggle').forEach(function(cb) { cb.checked = true; });
    applyColumnVisibility();
}

function initColumnVisibilityFromServer() {
    var hiddenCols = '@(Model.HiddenColumns ?? "")';
    if (!hiddenCols) return;
    var hidden = hiddenCols.split(',').filter(function(s) { return s.trim(); });
    if (hidden.length === 0) return;
    hidden.forEach(function(col) {
        var cb = document.querySelector('.col-toggle[value="' + col.trim() + '"]');
        if (cb) cb.checked = false;
    });
    applyColumnVisibility();
}

    // Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    updateStoreSelection();
    updateItemSelectionText();
    initColumnVisibilityFromServer();
    
    var itemSearchInput = document.getElementById('itemSearchInput');
    if (itemSearchInput) {
        itemSearchInput.addEventListener('input', scheduleItemSearch);
        itemSearchInput.addEventListener('paste', scheduleItemSearch);
    }
    var itemSearchIncludeInactive = document.getElementById('itemSearchIncludeInactive');
    if (itemSearchIncludeInactive) {
        itemSearchIncludeInactive.addEventListener('change', searchItems);
    }
    
    // Restore filter operator selections and wire live filtering
    document.querySelectorAll('.filter-op').forEach(function(select) {
        var col = select.dataset.col;
        var hidden = document.getElementById('fo_' + col);
        if (hidden && hidden.value) {
            select.value = hidden.value;
        }
    });
    
    // Live filter: debounced input on every keystroke
    document.querySelectorAll('.col-filter').forEach(function(input) {
        input.addEventListener('input', scheduleFilterApply);
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                applyColumnFilters(); // immediate on Enter
            }
        });
        // Mark active filters on load
        if (input.value.trim() !== '') input.classList.add('filter-active');
    });
    
    // Wire preset radios to update date fields
    document.querySelectorAll('input[name="DatePreset"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            applyPresetDates(this.value);
        });
    });
    
    const form = document.getElementById('reportForm');
    form.addEventListener('submit', function() {
        showLoading();
    });
    
    var generateBtn = document.getElementById('generateBtn');
    generateBtn.addEventListener('click', function() {
        resetPage();
    });
});
</script>
}
