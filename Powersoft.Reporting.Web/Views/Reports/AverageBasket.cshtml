@model Powersoft.Reporting.Web.ViewModels.AverageBasketViewModel
@{
    ViewData["Title"] = "Average Basket Report";
}

<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-controller="Reports" asp-action="Index">Reports</a></li>
                <li class="breadcrumb-item"><a href="#">Stock Control</a></li>
                <li class="breadcrumb-item active">Average Basket</li>
            </ol>
        </nav>
        <h2 class="mb-0">
            <i class="bi bi-basket me-2 text-primary"></i>Average Basket Report
        </h2>
        <p class="text-muted">Analyze sales performance and average transaction values</p>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-funnel me-2"></i>Report Parameters
    </div>
    <div class="card-body">
        <form asp-action="AverageBasket" method="post" id="reportForm">
            <!-- Date Presets -->
            <div class="row mb-3">
                <div class="col-12">
                    <label class="form-label fw-semibold mb-2">Quick Date Selection</label>
                    <div class="btn-group flex-wrap" role="group">
                        <input type="radio" class="btn-check" name="DatePreset" id="presetToday" value="today" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="presetToday">Today</label>
                        
                        <input type="radio" class="btn-check" name="DatePreset" id="presetYesterday" value="yesterday" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="presetYesterday">Yesterday</label>
                        
                        <input type="radio" class="btn-check" name="DatePreset" id="presetLast7" value="last7" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="presetLast7">Last 7 Days</label>
                        
                        <input type="radio" class="btn-check" name="DatePreset" id="presetLast30" value="last30" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="presetLast30">Last 30 Days</label>
                        
                        <input type="radio" class="btn-check" name="DatePreset" id="presetThisMonth" value="thisMonth" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="presetThisMonth">This Month</label>
                        
                        <input type="radio" class="btn-check" name="DatePreset" id="presetLastMonth" value="lastMonth" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="presetLastMonth">Last Month</label>
                        
                        <input type="radio" class="btn-check" name="DatePreset" id="presetYTD" value="ytd" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="presetYTD">Year to Date</label>
                        
                        <input type="radio" class="btn-check" name="DatePreset" id="presetLastYear" value="lastYear" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="presetLastYear">Last Year</label>
                    </div>
                </div>
            </div>
            
            <hr class="my-3">
            
            <!-- Main Parameters -->
            <div class="row g-3 align-items-end">
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Date From</label>
                    <input type="date" asp-for="DateFrom" class="form-control" />
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Date To</label>
                    <input type="date" asp-for="DateTo" class="form-control" />
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Breakdown</label>
                    <select asp-for="Breakdown" class="form-select" asp-items="Html.GetEnumSelectList<Powersoft.Reporting.Core.Enums.BreakdownType>()">
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Group By</label>
                    <select asp-for="GroupBy" class="form-select" asp-items="Html.GetEnumSelectList<Powersoft.Reporting.Core.Enums.GroupByType>()">
                    </select>
                </div>
                <div class="col-md-2">
                    <div class="form-check mt-4">
                        <input type="checkbox" asp-for="IncludeVat" class="form-check-input" />
                        <label asp-for="IncludeVat" class="form-check-label">Include VAT</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-play-fill me-1"></i>Generate
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>
        @Model.ErrorMessage
    </div>
}

@if (Model.Results.Any())
{
    <div class="row mb-4 g-3">
        <div class="col-md-3">
            <div class="stat-card text-center">
                <div class="stat-value">@Model.TotalTransactions.ToString("N0")</div>
                <div class="stat-label">Total Transactions</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center">
                <div class="stat-value">@Model.TotalQty.ToString("N0")</div>
                <div class="stat-label">Items Sold</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center">
                <div class="stat-value">@((Model.IncludeVat ? Model.TotalGrossSales : Model.TotalNetSales).ToString("N2"))</div>
                <div class="stat-label">Total Sales</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center">
                <div class="stat-value text-primary">@Model.OverallAverageBasket.ToString("N2")</div>
                <div class="stat-label">Average Basket</div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-table me-2"></i>Results (@Model.Results.Count rows)@(Model.HasGrouping ? $" - Grouped by {Model.GroupBy}" : "")</span>
            <button class="btn btn-outline-success btn-sm" onclick="exportToCSV()">
                <i class="bi bi-download me-1"></i>Export CSV
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="resultsTable">
                    <thead>
                        <tr>
                            @if (Model.HasGrouping)
                            {
                                <th>@Model.GroupBy</th>
                            }
                            <th>Period</th>
                            <th class="text-end">Invoices</th>
                            <th class="text-end">Returns</th>
                            <th class="text-end">Net Trans.</th>
                            <th class="text-end">Qty Sold</th>
                            <th class="text-end">Qty Ret.</th>
                            <th class="text-end">Net Qty</th>
                            <th class="text-end">@(Model.IncludeVat ? "Gross" : "Net") Sales</th>
                            <th class="text-end">Avg Basket</th>
                            <th class="text-end">Avg Qty</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in Model.Results)
                        {
                            var avgBasket = Model.IncludeVat ? row.CYAverageGross : row.CYAverageNet;
                            var totalSales = Model.IncludeVat ? row.CYTotalGross : row.CYTotalNet;
                            <tr>
                                @if (Model.HasGrouping)
                                {
                                    <td class="fw-semibold text-info">@(row.Level1Value ?? row.Level1 ?? "N/A")</td>
                                }
                                <td class="fw-semibold">@row.Period</td>
                                <td class="text-end">@row.CYInvoiceCount.ToString("N0")</td>
                                <td class="text-end text-danger">@row.CYCreditCount.ToString("N0")</td>
                                <td class="text-end fw-semibold">@row.CYTotalTransactions.ToString("N0")</td>
                                <td class="text-end">@row.CYQtySold.ToString("N0")</td>
                                <td class="text-end text-danger">@row.CYQtyReturned.ToString("N0")</td>
                                <td class="text-end fw-semibold">@row.CYTotalQty.ToString("N0")</td>
                                <td class="text-end">@totalSales.ToString("N2")</td>
                                <td class="text-end fw-semibold text-primary">@avgBasket.ToString("N2")</td>
                                <td class="text-end">@row.CYAverageQty.ToString("N2")</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="table-light">
                        <tr class="fw-bold">
                            @if (Model.HasGrouping)
                            {
                                <td></td>
                            }
                            <td>TOTAL</td>
                            <td class="text-end">@Model.Results.Sum(r => r.CYInvoiceCount).ToString("N0")</td>
                            <td class="text-end text-danger">@Model.Results.Sum(r => r.CYCreditCount).ToString("N0")</td>
                            <td class="text-end">@Model.TotalTransactions.ToString("N0")</td>
                            <td class="text-end">@Model.Results.Sum(r => r.CYQtySold).ToString("N0")</td>
                            <td class="text-end text-danger">@Model.Results.Sum(r => r.CYQtyReturned).ToString("N0")</td>
                            <td class="text-end">@Model.TotalQty.ToString("N0")</td>
                            <td class="text-end">@((Model.IncludeVat ? Model.TotalGrossSales : Model.TotalNetSales).ToString("N2"))</td>
                            <td class="text-end text-primary">@Model.OverallAverageBasket.ToString("N2")</td>
                            <td class="text-end">-</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
}
else if (ViewContext.HttpContext.Request.Method == "POST")
{
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3">No Data Found</h4>
            <p class="text-muted">No transactions found for the selected date range.</p>
        </div>
    </div>
}
else
{
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="bi bi-bar-chart text-primary" style="font-size: 4rem;"></i>
            <h4 class="mt-3">Generate Your Report</h4>
            <p class="text-muted">Select your parameters above and click "Generate" to view the Average Basket analysis.</p>
        </div>
    </div>
}

@section Scripts {
<script>
// Clear date preset when manually changing dates
document.getElementById('DateFrom').addEventListener('change', clearPreset);
document.getElementById('DateTo').addEventListener('change', clearPreset);

function clearPreset() {
    document.querySelectorAll('input[name="DatePreset"]').forEach(r => r.checked = false);
}

function exportToCSV() {
    const table = document.getElementById('resultsTable');
    let csv = [];
    
    // Headers
    const headers = [];
    table.querySelectorAll('thead th').forEach(th => headers.push('"' + th.textContent.trim() + '"'));
    csv.push(headers.join(','));
    
    // Data rows
    table.querySelectorAll('tbody tr').forEach(row => {
        const rowData = [];
        row.querySelectorAll('td').forEach(td => rowData.push('"' + td.textContent.trim() + '"'));
        csv.push(rowData.join(','));
    });
    
    // Download
    const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `AverageBasket_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
}
</script>
}
